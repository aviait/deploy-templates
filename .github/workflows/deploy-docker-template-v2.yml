name: Deploy Docker Project Template

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
      PROJECT_NAME:
        required: true
        type: string
      NODE_VERSION:
        required: false
        type: string
        default: "20"
      VERSION_CMD:
        required: false
        type: string
        default: "node -p \"require('./package.json').version\""
      PACKAGE_MANAGER:
        required: false
        type: string
        default: "yarn"
      INSTALL_CMD:
        required: false
        type: string
        default: "yarn install --immutable"
      BUILD_CMD:
        required: false
        type: string
        default: "yarn build"
      CACHE_DEPENDENCY_PATH:
        required: false
        type: string
        default: ""
      SSH_USER:
        required: true
        type: string
      SSH_HOST:
        required: true
        type: string
      DOCKER_IMAGE:
        required: true
        type: string
      CONTAINER_NAME:
        required: false
        type: string
        default: ""
      DOCKER_USERNAME:
        required: false
        type: string
        default: ""
      DOCKER_PASSWORD:
        required: false
        type: string
        default: ""
      DOCKER_RUN_ENVS:
        required: false
        type: string
        default: ""
      DOCKER_RUN_ENVS_FILE:
        required: false
        type: string
        default: ""
      DOCKER_PLATFORM:
        required: false
        type: string
        default: linux/amd64
      DOCKER_BUILD_ARGS:
        required: false
        type: string
        default: ""
      REGISTRY:
        required: false
        type: string
        default: docker.io
      IMAGE_NAMESPACE:
        required: false
        type: string
        default: ""
      IMAGE_RETENTION_COUNT:
        required: false
        type: number
        default: 5
      SSH_REMOTE_PORT:
        required: false
        type: number
        default: 22
      SSH_KNOWN_HOSTS:
        required: false
        type: string
        default: ""
      REMOTE_DOCKER_LOGIN:
        required: false
        type: boolean
        default: true
      HEALTHCHECK_URL:
        required: false
        type: string
        default: ""
      HEALTHCHECK_RETRIES:
        required: false
        type: number
        default: 12
      HEALTHCHECK_DELAY:
        required: false
        type: number
        default: 5
      PRUNE_RUNNER:
        required: false
        type: boolean
        default: true
    secrets:
      PEM_KEY:
        required: true
      DOCKER_USERNAME:
        required: false
      DOCKER_PASSWORD:
        required: false

jobs:
  deploy:
    name: üöÄ Deploy Docker Project ${{ inputs.PROJECT_NAME }} (${{ inputs.ENVIRONMENT }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: deploy-docker-${{ inputs.PROJECT_NAME }}-${{ inputs.ENVIRONMENT }}
      cancel-in-progress: true
    permissions:
      contents: read
    environment: ${{ inputs.ENVIRONMENT }}
    defaults:
      run:
        shell: bash
    outputs:
      version: ${{ steps.version.outputs.version }}
      image_ref: ${{ steps.image_metadata.outputs.image_ref }}
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME != '' && secrets.DOCKER_USERNAME || inputs.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD != '' && secrets.DOCKER_PASSWORD || inputs.DOCKER_PASSWORD }}
      REGISTRY: ${{ inputs.REGISTRY != '' && inputs.REGISTRY || 'docker.io' }}
      IMAGE_NAMESPACE: ${{ inputs.IMAGE_NAMESPACE != '' && inputs.IMAGE_NAMESPACE || (secrets.DOCKER_USERNAME != '' && secrets.DOCKER_USERNAME || inputs.DOCKER_USERNAME) }}

    steps:
      - name: üõí Checkout c√≥digo
        uses: actions/checkout@v6

      - name: üß∞ Configurar Node (cache customizado)
        if: ${{ inputs.CACHE_DEPENDENCY_PATH != '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}
          cache-dependency-path: ${{ inputs.CACHE_DEPENDENCY_PATH }}

      - name: üß∞ Configurar Node
        if: ${{ inputs.CACHE_DEPENDENCY_PATH == '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}

      - name: ‚úÖ Validar credenciais Docker
        run: |
          if ! [[ "${{ inputs.PACKAGE_MANAGER }}" =~ ^(npm|yarn|pnpm)$ ]]; then
            echo "::error::PACKAGE_MANAGER deve ser um destes valores: npm, yarn, pnpm."
            exit 1
          fi

          if [ -z "${{ inputs.VERSION_CMD }}" ]; then
            echo "::error::VERSION_CMD n√£o pode ser vazio."
            exit 1
          fi

          if [ -z "${{ inputs.INSTALL_CMD }}" ] || [ -z "${{ inputs.BUILD_CMD }}" ]; then
            echo "::error::INSTALL_CMD e BUILD_CMD n√£o podem ser vazios."
            exit 1
          fi

          if [ -z "${DOCKER_USERNAME}" ] || [ -z "${DOCKER_PASSWORD}" ]; then
            echo "::error::Informe DOCKER_USERNAME/DOCKER_PASSWORD via secrets ou via inputs."
            exit 1
          fi

          if [ -z "${IMAGE_NAMESPACE}" ]; then
            echo "::error::IMAGE_NAMESPACE ficou vazio. Informe IMAGE_NAMESPACE ou DOCKER_USERNAME."
            exit 1
          fi

          if [ -z "${{ inputs.DOCKER_RUN_ENVS }}" ] && [ -z "${{ inputs.DOCKER_RUN_ENVS_FILE }}" ]; then
            echo "::error::Informe DOCKER_RUN_ENVS ou DOCKER_RUN_ENVS_FILE."
            exit 1
          fi

          if ! [[ "${{ inputs.IMAGE_RETENTION_COUNT }}" =~ ^[1-9][0-9]*$ ]]; then
            echo "::error::IMAGE_RETENTION_COUNT deve ser um n√∫mero inteiro maior que zero."
            exit 1
          fi

      - name: üõ†Ô∏è Instalar depend√™ncias do projeto
        run: ${{ inputs.INSTALL_CMD }}

      - name: üèóÔ∏è Buildar o projeto
        run: ${{ inputs.BUILD_CMD }}

      - name: üîê Registrar host SSH em known_hosts
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ inputs.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ inputs.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          fi
          ssh-keyscan -H -p ${{ inputs.SSH_REMOTE_PORT }} ${{ inputs.SSH_HOST }} >> ~/.ssh/known_hosts
          sort -u ~/.ssh/known_hosts -o ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: üîë Configurar chave SSH privada
        run: |
          echo "${{ secrets.PEM_KEY }}" > ./deploy-key.pem
          chmod 600 ./deploy-key.pem

      - name: üî¢ Pegar vers√£o do projeto
        id: version
        run: |
          VERSION_CMD=$(cat << 'CMD'
          ${{ inputs.VERSION_CMD }}
          CMD
          )
          VERSION=$(bash -lc "${VERSION_CMD}")
          if [ -z "${VERSION}" ]; then
            echo "::error::VERSION_CMD retornou valor vazio."
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: ü™™ Registrar metadados da imagem
        id: image_metadata
        run: |
          IMAGE_REF="${REGISTRY}/${IMAGE_NAMESPACE}/${{ inputs.DOCKER_IMAGE }}:${VERSION}"
          echo "IMAGE_REF=${IMAGE_REF}" >> $GITHUB_ENV
          echo "image_ref=${IMAGE_REF}" >> $GITHUB_OUTPUT

      - name: üèóÔ∏è Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Login no Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: üê≥ Build e Push da imagem Docker (com cache)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.DOCKER_IMAGE }}:${{ env.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ inputs.DOCKER_IMAGE }}:latest
          platforms: ${{ inputs.DOCKER_PLATFORM }}
          build-args: ${{ inputs.DOCKER_BUILD_ARGS }}
          cache-from: type=gha,scope=${{ inputs.DOCKER_IMAGE }}
          cache-to: type=gha,mode=max,scope=${{ inputs.DOCKER_IMAGE }}
          provenance: true
          sbom: true
          labels: |
            org.opencontainers.image.title=${{ inputs.PROJECT_NAME }}
            org.opencontainers.image.version=${{ env.VERSION }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp || github.run_id }}

      - name: üöÄ Atualizar container no servidor
        run: |
          IMAGE_REF="${REGISTRY}/${IMAGE_NAMESPACE}/${{ inputs.DOCKER_IMAGE }}:${{ env.VERSION }}"
          REPOSITORY="${REGISTRY}/${IMAGE_NAMESPACE}/${{ inputs.DOCKER_IMAGE }}"
          SERVICE_NAME="${{ inputs.CONTAINER_NAME }}"
          if [ -z "${SERVICE_NAME}" ]; then
            SERVICE_NAME="${{ inputs.DOCKER_IMAGE }}"
          fi
          KEEP_IMAGES=${{ inputs.IMAGE_RETENTION_COUNT }}
          REMOTE_DOCKER_LOGIN="${{ inputs.REMOTE_DOCKER_LOGIN }}"
          DOCKER_ENV_MODE="inline"
          DOCKER_RUN_ENVS_B64=$(printf '%s' "${{ inputs.DOCKER_RUN_ENVS }}" | base64 | tr -d '\n')
          DOCKER_RUN_ENVS_FILE_B64=""

          if [ -n "${{ inputs.DOCKER_RUN_ENVS_FILE }}" ]; then
            DOCKER_ENV_MODE="file"
            DOCKER_RUN_ENVS_FILE_B64=$(printf '%s\n' "${{ inputs.DOCKER_RUN_ENVS_FILE }}" | base64 | tr -d '\n')
          fi

          HEALTHCHECK_URL="${{ inputs.HEALTHCHECK_URL }}"
          HEALTHCHECK_RETRIES=${{ inputs.HEALTHCHECK_RETRIES }}
          HEALTHCHECK_DELAY=${{ inputs.HEALTHCHECK_DELAY }}

          ssh -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p ${{ inputs.SSH_REMOTE_PORT }} -i ./deploy-key.pem \
            ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }} \
            env \
            DOCKER_USERNAME="${DOCKER_USERNAME}" \
            DOCKER_PASSWORD="${DOCKER_PASSWORD}" \
            REGISTRY="${REGISTRY}" \
            IMAGE_REF="${IMAGE_REF}" \
            REPOSITORY="${REPOSITORY}" \
            KEEP_IMAGES="${KEEP_IMAGES}" \
            SERVICE_NAME="${SERVICE_NAME}" \
            DOCKER_ENV_MODE="${DOCKER_ENV_MODE}" \
            DOCKER_RUN_ENVS_B64="${DOCKER_RUN_ENVS_B64}" \
            DOCKER_RUN_ENVS_FILE_B64="${DOCKER_RUN_ENVS_FILE_B64}" \
            REMOTE_DOCKER_LOGIN="${REMOTE_DOCKER_LOGIN}" \
            HEALTHCHECK_URL="${HEALTHCHECK_URL}" \
            HEALTHCHECK_RETRIES="${HEALTHCHECK_RETRIES}" \
            HEALTHCHECK_DELAY="${HEALTHCHECK_DELAY}" \
            bash -s << 'EOF'
            set -euo pipefail

            DOCKER_RUN_ENVS=$(printf '%s' "${DOCKER_RUN_ENVS_B64}" | base64 -d)

            DOCKER_ENV_OPTS="${DOCKER_RUN_ENVS}"
            TMP_ENV_FILE=""
            cleanup_tmp_env_file() {
              if [ -n "${TMP_ENV_FILE}" ] && [ -f "${TMP_ENV_FILE}" ]; then
                rm -f "${TMP_ENV_FILE}"
              fi
            }
            trap cleanup_tmp_env_file EXIT
            if [ "${DOCKER_ENV_MODE}" = "file" ]; then
              TMP_ENV_FILE=$(mktemp)
              printf '%s' "${DOCKER_RUN_ENVS_FILE_B64}" | base64 -d > "${TMP_ENV_FILE}"
              DOCKER_ENV_OPTS="--env-file ${TMP_ENV_FILE} ${DOCKER_ENV_OPTS}"
            fi

            PREVIOUS_IMAGE_ID=$(docker inspect -f '{{.Image}}' "${SERVICE_NAME}" 2>/dev/null || true)

            if [ "${REMOTE_DOCKER_LOGIN}" = "true" ]; then
              echo "${DOCKER_PASSWORD}" | docker login "${REGISTRY}" -u "${DOCKER_USERNAME}" --password-stdin
            fi

            docker pull "${IMAGE_REF}"

            docker stop "${SERVICE_NAME}" || true
            docker rm "${SERVICE_NAME}" || true

            if ! docker run -d --restart unless-stopped --name "${SERVICE_NAME}" \
              ${DOCKER_ENV_OPTS} \
              "${IMAGE_REF}"; then
              echo "Falha ao subir nova vers√£o; tentando rollback..."
              if [ -n "${PREVIOUS_IMAGE_ID}" ]; then
                docker run -d --restart unless-stopped --name "${SERVICE_NAME}" \
                  ${DOCKER_ENV_OPTS} \
                  "${PREVIOUS_IMAGE_ID}" || true
              fi
              exit 1
            fi

            sleep 5
            if ! docker ps --filter "name=${SERVICE_NAME}" --filter "status=running" --format '{{.ID}}' | grep -q .; then
              echo "Container n√£o est√° em execu√ß√£o ap√≥s o deploy; rollback."
              docker stop "${SERVICE_NAME}" || true
              docker rm "${SERVICE_NAME}" || true
              if [ -n "${PREVIOUS_IMAGE_ID}" ]; then
                docker run -d --restart unless-stopped --name "${SERVICE_NAME}" \
                  ${DOCKER_ENV_OPTS} \
                  "${PREVIOUS_IMAGE_ID}" || true
              fi
              exit 1
            fi

            if [ -n "${HEALTHCHECK_URL}" ]; then
              if ! command -v curl >/dev/null 2>&1; then
                echo "curl n√£o encontrado no servidor; pulando healthcheck solicitado."
              else
              attempt=1
              success=0
              while [ $attempt -le "${HEALTHCHECK_RETRIES}" ]; do
                if curl -fsSL --max-time 5 "${HEALTHCHECK_URL}"; then
                  success=1
                  break
                fi
                echo "Healthcheck falhou (tentativa ${attempt}/${HEALTHCHECK_RETRIES}); aguardando ${HEALTHCHECK_DELAY}s"
                attempt=$((attempt+1))
                sleep "${HEALTHCHECK_DELAY}"
              done

              if [ $success -ne 1 ]; then
                echo "Healthcheck n√£o passou; rollback."
                docker stop "${SERVICE_NAME}" || true
                docker rm "${SERVICE_NAME}" || true
                if [ -n "${PREVIOUS_IMAGE_ID}" ]; then
                  docker run -d --restart unless-stopped --name "${SERVICE_NAME}" \
                    ${DOCKER_ENV_OPTS} \
                    "${PREVIOUS_IMAGE_ID}" || true
                fi
                exit 1
              fi
              fi
            fi

            OLD_IMAGE_IDS=$(docker image ls "${REPOSITORY}" --format '{{.CreatedAt}} {{.ID}}' | sort -r | awk "NR>${KEEP_IMAGES}{print \$2}")
            if [ -n "${OLD_IMAGE_IDS}" ]; then
              echo "${OLD_IMAGE_IDS}" | xargs -r docker image rm -f || true
            fi
            docker image prune -f >/dev/null 2>&1 || true
          EOF

      - name: üßπ Apagar chave privada ap√≥s deploy
        if: always()
        run: rm -f ./deploy-key.pem

      - name: üßπ Limpar imagens locais do runner
        if: ${{ always() && inputs.PRUNE_RUNNER }}
        run: docker system prune -af --volumes || true

      - name: üìù Resumo do deploy
        if: always()
        run: |
          {
            echo "## Deploy Docker"
            echo "- Projeto: ${{ inputs.PROJECT_NAME }}"
            echo "- Ambiente: ${{ inputs.ENVIRONMENT }}"
            echo "- Imagem: ${REGISTRY}/${IMAGE_NAMESPACE}/${{ inputs.DOCKER_IMAGE }}:${{ env.VERSION }}"
            echo "- Plataforma: ${{ inputs.DOCKER_PLATFORM }}"
            echo "- Imagens retidas: ${{ inputs.IMAGE_RETENTION_COUNT }}"
          } >> $GITHUB_STEP_SUMMARY
