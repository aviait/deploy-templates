name: Deploy Static Project Template

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
      PROJECT_NAME:
        required: true
        type: string
      REMOTE_DIR:
        required: true
        type: string
      SSH_USER:
        required: true
        type: string
      SSH_HOST:
        required: true
        type: string
    secrets:
      PEM_KEY:
        required: true

jobs:
  deploy:
    name: üöÄ Deploy Static Project ${{ inputs.PROJECT_NAME }} (${{ inputs.ENVIRONMENT }})
    runs-on: ubuntu-latest

    steps:
      - name: üõí Checkout c√≥digo
        uses: actions/checkout@v2

      - name: üõ†Ô∏è Instalar depend√™ncias do projeto
        run: yarn install

      - name: üèóÔ∏è Buildar o projeto
        run: yarn build

      - name: üîç Verificar conte√∫do da pasta build
        run: ls -la ./build

      - name: üõ†Ô∏è Instalar rsync e cliente SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: üîë Configurar chave SSH privada
        run: |
          echo "${{ secrets.PEM_KEY }}" > ./deploy-key.pem
          chmod 600 ./deploy-key.pem

      - name: üîç Criar diret√≥rio remoto se n√£o existir
        run: |
          ssh -o StrictHostKeyChecking=no -i ./deploy-key.pem ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }} "sudo mkdir -p '${{ inputs.REMOTE_DIR }}' && sudo chown ${{ inputs.SSH_USER }}:${{ inputs.SSH_USER }} '${{ inputs.REMOTE_DIR }}'"

      - name: üöö Enviar arquivos est√°ticos via rsync
        run: |
          rsync -avz --delete --progress --stats ./build/ \
            -e "ssh -o StrictHostKeyChecking=no -i ./deploy-key.pem" \
            ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }}:"${{ inputs.REMOTE_DIR }}"

      - name: üßπ Apagar chave privada
        if: always()
        run: rm -f ./deploy-key.pem
