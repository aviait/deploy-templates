name: "[DEPRECATED] Deploy Static Project Template"

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
      PROJECT_NAME:
        required: true
        type: string
      REMOTE_DIR:
        required: true
        type: string
      SSH_USER:
        required: true
        type: string
      SSH_HOST:
        required: true
        type: string
      SSH_REMOTE_PORT:
        required: false
        type: number
        default: 22
    secrets:
      PEM_KEY:
        required: true

jobs:
  deploy:
    name: üöÄ Deploy Static Project ${{ inputs.PROJECT_NAME }} (${{ inputs.ENVIRONMENT }})
    runs-on: ubuntu-latest

    steps:
      - name: ‚ö†Ô∏è Aviso de deprecia√ß√£o
        run: |
          echo "::warning::Template legado. Migre para .github/workflows/deploy-static-template-v2.yml."
          {
            echo "## Aviso de deprecia√ß√£o"
            echo "Este workflow √© legado e ser√° removido em vers√£o futura."
            echo "Migre para: \`.github/workflows/deploy-static-template-v2.yml\`."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: üõí Checkout c√≥digo
        uses: actions/checkout@v6

      - name: üõ†Ô∏è Instalar depend√™ncias do projeto
        run: yarn install

      - name: üèóÔ∏è Buildar o projeto
        run: yarn build

      - name: üîç Verificar conte√∫do da pasta build
        run: ls -la ./build

      - name: üõ†Ô∏è Instalar rsync e cliente SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: üîê Registrar host SSH em known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H -p ${{ inputs.SSH_REMOTE_PORT }} ${{ inputs.SSH_HOST }} >> ~/.ssh/known_hosts
          sort -u ~/.ssh/known_hosts -o ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: üîë Configurar chave SSH privada
        run: |
          echo "${{ secrets.PEM_KEY }}" > ./deploy-key.pem
          chmod 600 ./deploy-key.pem

      - name: üîç Criar diret√≥rio remoto se n√£o existir
        run: |
          ssh -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p ${{ inputs.SSH_REMOTE_PORT }} -i ./deploy-key.pem ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }} "sudo mkdir -p '${{ inputs.REMOTE_DIR }}' && sudo chown ${{ inputs.SSH_USER }}:${{ inputs.SSH_USER }} '${{ inputs.REMOTE_DIR }}'"

      - name: üöö Enviar arquivos est√°ticos via rsync
        run: |
          rsync -avz --delete --progress --stats ./build/ \
            -e "ssh -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p ${{ inputs.SSH_REMOTE_PORT }} -i ./deploy-key.pem" \
            ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }}:"${{ inputs.REMOTE_DIR }}"

      - name: üßπ Apagar chave privada
        if: always()
        run: rm -f ./deploy-key.pem
