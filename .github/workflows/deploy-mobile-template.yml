name: Deploy Mobile Apps Template

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
      PROJECT_NAME:
        required: true
        type: string
      WORKING_DIRECTORY:
        required: false
        type: string
        default: "."
      ANDROID_WORKING_DIRECTORY:
        required: false
        type: string
        default: "."
      IOS_WORKING_DIRECTORY:
        required: false
        type: string
        default: "."
      NODE_VERSION:
        required: false
        type: string
        default: "20"
      PACKAGE_MANAGER:
        required: false
        type: string
        default: "yarn"
      INSTALL_CMD:
        required: false
        type: string
        default: "yarn install --immutable"
      CACHE_DEPENDENCY_PATH:
        required: false
        type: string
        default: ""
      BUILD_ANDROID:
        required: false
        type: boolean
        default: true
      BUILD_IOS:
        required: false
        type: boolean
        default: true
      UPLOAD_ARTIFACT:
        required: false
        type: boolean
        default: true
      ANDROID_JAVA_VERSION:
        required: false
        type: string
        default: "17"
      ANDROID_BUILD_CMD:
        required: false
        type: string
        default: "./gradlew :app:bundleRelease"
      ANDROID_PREPARE_CMD:
        required: false
        type: string
        default: ""
      ANDROID_ARTIFACT_PATH:
        required: false
        type: string
        default: "android/app/build/outputs/bundle/release/*.aab"
      ANDROID_ARTIFACT_NAME:
        required: false
        type: string
        default: "android-release"
      ANDROID_PUBLISH_CMD:
        required: false
        type: string
        default: ""
      RUBY_VERSION:
        required: false
        type: string
        default: "3.3"
      IOS_USE_BUNDLER_CACHE:
        required: false
        type: boolean
        default: false
      IOS_PREPARE_CMD:
        required: false
        type: string
        default: ""
      IOS_BUILD_CMD:
        required: false
        type: string
        default: "xcodebuild -workspace ios/Runner.xcworkspace -scheme Runner -configuration Release -archivePath build/Runner.xcarchive archive"
      IOS_EXPORT_CMD:
        required: false
        type: string
        default: ""
      IOS_ARTIFACT_PATH:
        required: false
        type: string
        default: "build/**/*.ipa"
      IOS_ARTIFACT_NAME:
        required: false
        type: string
        default: "ios-release"
      IOS_PUBLISH_CMD:
        required: false
        type: string
        default: ""

jobs:
  validate:
    name: âœ… Validar configuraÃ§Ã£o mobile
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        shell: bash
    steps:
      - name: Validar inputs bÃ¡sicos
        run: |
          if [ "${{ inputs.BUILD_ANDROID }}" != "true" ] && [ "${{ inputs.BUILD_IOS }}" != "true" ]; then
            echo "::error::Ative pelo menos uma plataforma: BUILD_ANDROID=true ou BUILD_IOS=true."
            exit 1
          fi

          if ! [[ "${{ inputs.PACKAGE_MANAGER }}" =~ ^(npm|yarn|pnpm)$ ]]; then
            echo "::error::PACKAGE_MANAGER deve ser um destes valores: npm, yarn, pnpm."
            exit 1
          fi

          if [ -z "${{ inputs.INSTALL_CMD }}" ]; then
            echo "::error::INSTALL_CMD nÃ£o pode ser vazio."
            exit 1
          fi

          if [ "${{ inputs.BUILD_ANDROID }}" = "true" ] && [ -z "${{ inputs.ANDROID_BUILD_CMD }}" ]; then
            echo "::error::ANDROID_BUILD_CMD nÃ£o pode ser vazio quando BUILD_ANDROID=true."
            exit 1
          fi

          if [ "${{ inputs.BUILD_ANDROID }}" = "true" ] && [ -z "${{ inputs.ANDROID_WORKING_DIRECTORY }}" ]; then
            echo "::error::ANDROID_WORKING_DIRECTORY nÃ£o pode ser vazio quando BUILD_ANDROID=true."
            exit 1
          fi

          if [ "${{ inputs.BUILD_IOS }}" = "true" ] && [ -z "${{ inputs.IOS_BUILD_CMD }}" ]; then
            echo "::error::IOS_BUILD_CMD nÃ£o pode ser vazio quando BUILD_IOS=true."
            exit 1
          fi

          if [ "${{ inputs.BUILD_IOS }}" = "true" ] && [ -z "${{ inputs.IOS_WORKING_DIRECTORY }}" ]; then
            echo "::error::IOS_WORKING_DIRECTORY nÃ£o pode ser vazio quando BUILD_IOS=true."
            exit 1
          fi

  android:
    name: ðŸ¤– Android (${{ inputs.PROJECT_NAME }})
    if: ${{ inputs.BUILD_ANDROID }}
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 45
    concurrency:
      group: deploy-mobile-android-${{ inputs.PROJECT_NAME }}-${{ inputs.ENVIRONMENT }}
      cancel-in-progress: true
    permissions:
      contents: read
    environment: ${{ inputs.ENVIRONMENT }}
    defaults:
      run:
        shell: bash
    steps:
      - name: ðŸ›’ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: ðŸ§° Configurar Node (cache customizado)
        if: ${{ inputs.CACHE_DEPENDENCY_PATH != '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}
          cache-dependency-path: ${{ inputs.CACHE_DEPENDENCY_PATH }}

      - name: ðŸ§° Configurar Node
        if: ${{ inputs.CACHE_DEPENDENCY_PATH == '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}

      - name: â˜• Configurar Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ inputs.ANDROID_JAVA_VERSION }}

      - name: ðŸ› ï¸ Instalar dependÃªncias
        run: ${{ inputs.INSTALL_CMD }}
        working-directory: ${{ inputs.WORKING_DIRECTORY }}

      - name: ðŸ§° Preparar Android (opcional)
        if: ${{ inputs.ANDROID_PREPARE_CMD != '' }}
        run: ${{ inputs.ANDROID_PREPARE_CMD }}
        working-directory: ${{ inputs.ANDROID_WORKING_DIRECTORY != '.' && inputs.ANDROID_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ—ï¸ Build Android
        run: ${{ inputs.ANDROID_BUILD_CMD }}
        working-directory: ${{ inputs.ANDROID_WORKING_DIRECTORY != '.' && inputs.ANDROID_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ” Validar artefato Android
        run: |
          shopt -s globstar nullglob
          MATCHES=(${{ inputs.ANDROID_ARTIFACT_PATH }})
          if [ ${#MATCHES[@]} -eq 0 ]; then
            echo "::error::Nenhum artefato Android encontrado em '${{ inputs.ANDROID_ARTIFACT_PATH }}'."
            exit 1
          fi
          printf '%s\n' "${MATCHES[@]}"
        working-directory: ${{ inputs.ANDROID_WORKING_DIRECTORY != '.' && inputs.ANDROID_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ“¦ Publicar artefato Android
        if: ${{ inputs.UPLOAD_ARTIFACT }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.ANDROID_ARTIFACT_NAME }}
          path: ${{ (inputs.ANDROID_WORKING_DIRECTORY != '.' && inputs.ANDROID_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY) }}/${{ inputs.ANDROID_ARTIFACT_PATH }}

      - name: ðŸš€ Publicar Android (opcional)
        if: ${{ inputs.ANDROID_PUBLISH_CMD != '' }}
        run: ${{ inputs.ANDROID_PUBLISH_CMD }}
        working-directory: ${{ inputs.ANDROID_WORKING_DIRECTORY != '.' && inputs.ANDROID_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ“ Resumo Android
        if: always()
        run: |
          {
            echo "## Deploy Mobile - Android"
            echo "- Projeto: ${{ inputs.PROJECT_NAME }}"
            echo "- Ambiente: ${{ inputs.ENVIRONMENT }}"
            echo "- Comando build: \`${{ inputs.ANDROID_BUILD_CMD }}\`"
            echo "- Artefato: \`${{ inputs.ANDROID_ARTIFACT_PATH }}\`"
          } >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ inputs.ANDROID_WORKING_DIRECTORY != '.' && inputs.ANDROID_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

  ios:
    name: ðŸŽ iOS (${{ inputs.PROJECT_NAME }})
    if: ${{ inputs.BUILD_IOS }}
    needs: validate
    runs-on: macos-latest
    timeout-minutes: 90
    concurrency:
      group: deploy-mobile-ios-${{ inputs.PROJECT_NAME }}-${{ inputs.ENVIRONMENT }}
      cancel-in-progress: true
    permissions:
      contents: read
    environment: ${{ inputs.ENVIRONMENT }}
    defaults:
      run:
        shell: bash
    steps:
      - name: ðŸ›’ Checkout cÃ³digo
        uses: actions/checkout@v6

      - name: ðŸ§° Configurar Node (cache customizado)
        if: ${{ inputs.CACHE_DEPENDENCY_PATH != '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}
          cache-dependency-path: ${{ inputs.CACHE_DEPENDENCY_PATH }}

      - name: ðŸ§° Configurar Node
        if: ${{ inputs.CACHE_DEPENDENCY_PATH == '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}

      - name: ðŸ’Ž Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ inputs.RUBY_VERSION }}
          bundler-cache: ${{ inputs.IOS_USE_BUNDLER_CACHE }}

      - name: ðŸ› ï¸ Instalar dependÃªncias
        run: ${{ inputs.INSTALL_CMD }}
        working-directory: ${{ inputs.WORKING_DIRECTORY }}

      - name: ðŸ§° Preparar iOS (opcional)
        if: ${{ inputs.IOS_PREPARE_CMD != '' }}
        run: ${{ inputs.IOS_PREPARE_CMD }}
        working-directory: ${{ inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ—ï¸ Build iOS
        run: ${{ inputs.IOS_BUILD_CMD }}
        working-directory: ${{ inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ“¤ Exportar IPA (opcional)
        if: ${{ inputs.IOS_EXPORT_CMD != '' }}
        run: ${{ inputs.IOS_EXPORT_CMD }}
        working-directory: ${{ inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ” Validar artefato iOS
        run: |
          shopt -s globstar nullglob
          MATCHES=(${{ inputs.IOS_ARTIFACT_PATH }})
          if [ ${#MATCHES[@]} -eq 0 ]; then
            echo "::error::Nenhum artefato iOS encontrado em '${{ inputs.IOS_ARTIFACT_PATH }}'."
            exit 1
          fi
          printf '%s\n' "${MATCHES[@]}"
        working-directory: ${{ inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ“¦ Publicar artefato iOS
        if: ${{ inputs.UPLOAD_ARTIFACT }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.IOS_ARTIFACT_NAME }}
          path: ${{ (inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY) }}/${{ inputs.IOS_ARTIFACT_PATH }}

      - name: ðŸš€ Publicar iOS (opcional)
        if: ${{ inputs.IOS_PUBLISH_CMD != '' }}
        run: ${{ inputs.IOS_PUBLISH_CMD }}
        working-directory: ${{ inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}

      - name: ðŸ“ Resumo iOS
        if: always()
        run: |
          {
            echo "## Deploy Mobile - iOS"
            echo "- Projeto: ${{ inputs.PROJECT_NAME }}"
            echo "- Ambiente: ${{ inputs.ENVIRONMENT }}"
            echo "- Comando build: \`${{ inputs.IOS_BUILD_CMD }}\`"
            echo "- Artefato: \`${{ inputs.IOS_ARTIFACT_PATH }}\`"
          } >> $GITHUB_STEP_SUMMARY
        working-directory: ${{ inputs.IOS_WORKING_DIRECTORY != '.' && inputs.IOS_WORKING_DIRECTORY || inputs.WORKING_DIRECTORY }}
