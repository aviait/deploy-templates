name: Deploy Static Project Template

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        type: string
      PROJECT_NAME:
        required: true
        type: string
      NODE_VERSION:
        required: false
        type: string
        default: "20"
      PACKAGE_MANAGER:
        required: false
        type: string
        default: "yarn"
      INSTALL_CMD:
        required: false
        type: string
        default: "yarn install --immutable"
      BUILD_CMD:
        required: false
        type: string
        default: "yarn build"
      CACHE_DEPENDENCY_PATH:
        required: false
        type: string
        default: ""
      BUILD_DIR:
        required: false
        type: string
        default: "build"
      REMOTE_DIR:
        required: true
        type: string
      REMOTE_OWNER:
        required: false
        type: string
        default: "__AUTO__"
      SSH_USER:
        required: true
        type: string
      SSH_HOST:
        required: true
        type: string
      SSH_KNOWN_HOSTS:
        required: false
        type: string
        default: ""
      REQUIRE_SSH_KNOWN_HOSTS:
        required: false
        type: boolean
        default: false
      SSH_REMOTE_PORT:
        required: false
        type: number
        default: 22
      RSYNC_EXCLUDES:
        required: false
        type: string
        default: ""
      UPLOAD_ARTIFACT:
        required: false
        type: boolean
        default: false
      ARTIFACT_NAME:
        required: false
        type: string
        default: "static-build"
    secrets:
      PEM_KEY:
        required: true

jobs:
  deploy:
    name: üöÄ Deploy Static Project ${{ inputs.PROJECT_NAME }} (${{ inputs.ENVIRONMENT }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: deploy-static-${{ inputs.PROJECT_NAME }}-${{ inputs.ENVIRONMENT }}
      cancel-in-progress: true
    permissions:
      contents: read
    environment: ${{ inputs.ENVIRONMENT }}
    defaults:
      run:
        shell: bash

    steps:
      - name: üõí Checkout c√≥digo
        uses: actions/checkout@v6

      - name: üß∞ Configurar Node (cache customizado)
        if: ${{ inputs.CACHE_DEPENDENCY_PATH != '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}
          cache-dependency-path: ${{ inputs.CACHE_DEPENDENCY_PATH }}

      - name: üß∞ Configurar Node
        if: ${{ inputs.CACHE_DEPENDENCY_PATH == '' }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: ${{ inputs.PACKAGE_MANAGER }}

      - name: ‚úÖ Validar inputs do template
        run: |
          if ! [[ "${{ inputs.PACKAGE_MANAGER }}" =~ ^(npm|yarn|pnpm)$ ]]; then
            echo "::error::PACKAGE_MANAGER deve ser um destes valores: npm, yarn, pnpm."
            exit 1
          fi
          if [ -z "${{ inputs.INSTALL_CMD }}" ] || [ -z "${{ inputs.BUILD_CMD }}" ]; then
            echo "::error::INSTALL_CMD e BUILD_CMD n√£o podem ser vazios."
            exit 1
          fi

          if [ "${{ inputs.REQUIRE_SSH_KNOWN_HOSTS }}" = "true" ] && [ -z "${{ inputs.SSH_KNOWN_HOSTS }}" ]; then
            echo "::error::REQUIRE_SSH_KNOWN_HOSTS=true exige SSH_KNOWN_HOSTS preenchido."
            exit 1
          fi

      - name: üõ†Ô∏è Instalar depend√™ncias do projeto
        run: ${{ inputs.INSTALL_CMD }}

      - name: üèóÔ∏è Buildar o projeto
        run: ${{ inputs.BUILD_CMD }}

      - name: üîç Validar pasta de build
        run: |
          if [ ! -d "${{ inputs.BUILD_DIR }}" ]; then
            echo "::error::Pasta ${{ inputs.BUILD_DIR }} n√£o encontrada."
            exit 1
          fi
          if [ -z "$(ls -A "${{ inputs.BUILD_DIR }}")" ]; then
            echo "::error::Pasta ${{ inputs.BUILD_DIR }} est√° vazia."
            exit 1
          fi
          ls -la "${{ inputs.BUILD_DIR }}"

      - name: üõ†Ô∏è Instalar rsync e cliente SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y rsync openssh-client

      - name: üîê Registrar host SSH em known_hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          if [ -n "${{ inputs.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ inputs.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          fi

          if [ "${{ inputs.REQUIRE_SSH_KNOWN_HOSTS }}" != "true" ]; then
            ssh-keyscan -H -p ${{ inputs.SSH_REMOTE_PORT }} ${{ inputs.SSH_HOST }} >> ~/.ssh/known_hosts
          fi

          sort -u ~/.ssh/known_hosts -o ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: üîë Configurar chave SSH privada
        run: |
          echo "${{ secrets.PEM_KEY }}" > ./deploy-key.pem
          chmod 600 ./deploy-key.pem

      - name: üîç Criar diret√≥rio remoto se n√£o existir
        run: |
          REMOTE_OWNER="${{ inputs.REMOTE_OWNER }}"
          if [ "${REMOTE_OWNER}" = "__AUTO__" ]; then
            REMOTE_OWNER="${{ inputs.SSH_USER }}:${{ inputs.SSH_USER }}"
          fi

          ssh -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p ${{ inputs.SSH_REMOTE_PORT }} -i ./deploy-key.pem \
            ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }} \
            "sudo mkdir -p '${{ inputs.REMOTE_DIR }}' && if [ -n '${REMOTE_OWNER}' ]; then sudo chown '${REMOTE_OWNER}' '${{ inputs.REMOTE_DIR }}'; fi"

      - name: üöö Enviar arquivos est√°ticos via rsync
        run: |
          EXCLUDES=()
          if [ -n "${{ inputs.RSYNC_EXCLUDES }}" ]; then
            while IFS= read -r pattern; do
              [ -z "$pattern" ] && continue
              EXCLUDES+=("--exclude=$pattern")
            done <<< "${{ inputs.RSYNC_EXCLUDES }}"
          fi
          rsync -avz --delete --progress --stats "${EXCLUDES[@]}" "${{ inputs.BUILD_DIR }}/" \
            -e "ssh -o StrictHostKeyChecking=yes -o UserKnownHostsFile=~/.ssh/known_hosts -p ${{ inputs.SSH_REMOTE_PORT }} -i ./deploy-key.pem" \
            ${{ inputs.SSH_USER }}@${{ inputs.SSH_HOST }}:"${{ inputs.REMOTE_DIR }}"

      - name: üßπ Apagar chave privada
        if: always()
        run: rm -f ./deploy-key.pem

      - name: üì¶ Publicar artefato (opcional)
        if: ${{ inputs.UPLOAD_ARTIFACT }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.ARTIFACT_NAME }}
          path: ${{ inputs.BUILD_DIR }}

      - name: üìù Resumo do deploy
        if: always()
        run: |
          {
            echo "## Deploy Static"
            echo "- Projeto: ${{ inputs.PROJECT_NAME }}"
            echo "- Ambiente: ${{ inputs.ENVIRONMENT }}"
            echo "- Diret√≥rio build: ${{ inputs.BUILD_DIR }}"
            echo "- Destino remoto: ${{ inputs.REMOTE_DIR }}"
          } >> $GITHUB_STEP_SUMMARY
